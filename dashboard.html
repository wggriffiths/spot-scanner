<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Spot Momentum Scanner</title>
  <style>
    :root {
      --bg:          #070b14;
      --bg2:         #0c1220;
      --surface:     #111827;
      --surface2:    #1a2235;
      --surface3:    #1e2c40;
      --border:      #1e2d45;
      --border2:     #2a3f5f;
      --text:        #e2e8f0;
      --muted:       #6b7280;
      --dim:         #94a3b8;
      --accent:      #3b82f6;
      --accent-bg:   rgba(59,130,246,.14);
      --green:       #22c55e;
      --green-bg:    rgba(34,197,94,.14);
      --red:         #ef4444;
      --red-bg:      rgba(239,68,68,.14);
      --yellow:      #eab308;
      --yellow-bg:   rgba(234,179,8,.14);
      --r:           10px;
      --r-sm:        6px;
    }

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html { scroll-behavior: smooth; }
    body {
      background: var(--bg);
      color: var(--text);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      font-size: 14px;
      line-height: 1.5;
      min-height: 100svh;
    }

    /* â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .header {
      position: sticky; top: 0; z-index: 100;
      background: var(--bg2);
      border-bottom: 1px solid var(--border);
      height: 52px;
      display: flex; align-items: center; gap: 12px;
      padding: 0 16px;
    }
    .brand {
      display: flex; align-items: center; gap: 9px;
      flex-shrink: 0;
    }
    .brand-icon {
      width: 30px; height: 30px;
      background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
      border-radius: 8px;
      display: flex; align-items: center; justify-content: center;
      font-size: 15px;
    }
    .brand-name {
      font-size: 15px; font-weight: 700;
    }
    .brand-name span { color: var(--accent); }

    .header-status {
      display: flex; align-items: center; gap: 6px;
      font-size: 12px; color: var(--muted);
    }
    .status-dot {
      width: 7px; height: 7px; border-radius: 50%;
      background: var(--green);
      animation: pulse 2.2s ease-in-out infinite;
    }
    .status-dot.err { background: var(--red); animation: blink 1.2s ease-in-out infinite; }
    @keyframes pulse {
      0%,100% { box-shadow: 0 0 0 0 rgba(34,197,94,.5); }
      50%      { box-shadow: 0 0 0 5px rgba(34,197,94,0); }
    }
    @keyframes blink { 0%,100%{opacity:1} 50%{opacity:.3} }

    .hspacer { flex: 1; }

    .header-actions { display: flex; align-items: center; gap: 8px; }

    .refresh-wrap {
      display: flex; align-items: center; gap: 6px;
      font-size: 11px; color: var(--muted);
    }
    .refresh-wrap.hidden { visibility: hidden; }
    .spinner {
      width: 13px; height: 13px;
      border: 2px solid var(--border2);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin .7s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .icon-btn {
      width: 32px; height: 32px;
      border: 1px solid var(--border);
      background: var(--surface);
      color: var(--muted);
      border-radius: var(--r-sm);
      cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      font-size: 15px;
      transition: all .15s;
    }
    .icon-btn:hover { border-color: var(--border2); color: var(--text); }
    .icon-btn.on { border-color: var(--accent); color: var(--accent); background: var(--accent-bg); }

    /* â”€â”€ Stats bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .stats-bar {
      background: var(--bg2);
      border-bottom: 1px solid var(--border);
      padding: 8px 16px;
      display: flex; gap: 20px; align-items: center;
      overflow-x: auto; scrollbar-width: none;
    }
    .stats-bar::-webkit-scrollbar { display: none; }
    .stat { display: flex; flex-direction: column; gap: 1px; flex-shrink: 0; }
    .stat-lbl { font-size: 10px; color: var(--muted); text-transform: uppercase; letter-spacing: .5px; }
    .stat-val { font-size: 20px; font-weight: 700; line-height: 1.1; }
    .stat-val.a { color: var(--accent); }
    .stat-val.g { color: var(--green); }
    .stat-val.y { color: var(--yellow); }
    .stat-sep { width: 1px; height: 32px; background: var(--border); flex-shrink: 0; }

    /* â”€â”€ Main â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .main {
      max-width: 1400px; width: 100%; margin: 0 auto;
      padding: 14px 16px;
    }

    /* â”€â”€ Controls bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .ctrl-bar {
      display: flex; flex-wrap: wrap; gap: 8px; align-items: center;
      margin-bottom: 12px;
    }
    .tabs {
      display: flex; gap: 3px;
      background: var(--surface); border: 1px solid var(--border);
      border-radius: var(--r); padding: 3px;
    }
    .tab-btn {
      display: flex; align-items: center; gap: 5px;
      padding: 5px 12px;
      border: 1px solid transparent;
      background: transparent; color: var(--muted);
      border-radius: calc(var(--r) - 2px);
      cursor: pointer; font-size: 13px; font-weight: 500;
      transition: all .15s; white-space: nowrap;
    }
    .tab-btn:hover:not(.active) { color: var(--text); background: var(--surface2); }
    .tab-btn.active { background: var(--surface3); color: var(--text); border-color: var(--border2); }
    .badge {
      background: var(--accent-bg); color: var(--accent);
      border: 1px solid rgba(59,130,246,.35);
      border-radius: 999px; font-size: 10px; font-weight: 700;
      padding: 0 6px; min-width: 18px; text-align: center; line-height: 18px;
    }
    .tab-btn.active .badge { background: var(--accent); color: #fff; border-color: var(--accent); }

    .ctrl-spacer { flex: 1; min-width: 0; }
    .ctrl-group {
      display: flex; align-items: center; gap: 7px;
      background: var(--surface); border: 1px solid var(--border);
      border-radius: var(--r-sm); padding: 5px 9px;
    }
    .ctrl-lbl { font-size: 11px; color: var(--muted); white-space: nowrap; text-transform: uppercase; letter-spacing: .4px; }
    .ctrl-val { font-size: 13px; font-weight: 600; min-width: 22px; }
    input[type="range"] { width: 90px; accent-color: var(--accent); cursor: pointer; }
    input[type="search"] {
      border: 1px solid var(--border); background: var(--surface);
      color: var(--text); border-radius: var(--r-sm);
      padding: 5px 10px; font-size: 13px; width: 140px; outline: none;
      transition: border-color .15s;
    }
    input[type="search"]:focus { border-color: var(--accent); }

    /* â”€â”€ Panels â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .panel { display: none; }
    .panel.active { display: block; }

    /* â”€â”€ Table card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .tcard {
      background: var(--surface); border: 1px solid var(--border);
      border-radius: var(--r); overflow: hidden;
    }
    .tcard-scroll { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; }
    thead { z-index: 10; }
    th {
      padding: 9px 13px;
      background: var(--surface2);
      color: var(--muted); font-size: 11px; font-weight: 600;
      text-transform: uppercase; letter-spacing: .5px;
      text-align: left; border-bottom: 1px solid var(--border);
      white-space: nowrap; user-select: none;
    }
    th[data-sort] { cursor: pointer; }
    th[data-sort]:hover { color: var(--dim); }
    .sort-ic { margin-left: 3px; opacity: .4; font-size: 10px; }
    th.sorted .sort-ic { opacity: 1; color: var(--accent); }
    tbody tr {
      border-bottom: 1px solid var(--border);
      transition: background .12s;
    }
    tbody tr:last-child { border-bottom: none; }
    tbody tr:hover { background: var(--surface2); }
    tbody tr.new-row { animation: row-flash 2s ease-out; }
    @keyframes row-flash {
      0%   { background: rgba(59,130,246,.22); }
      100% { background: transparent; }
    }
    td { padding: 9px 13px; font-size: 13px; }

    .det-row td { background: var(--bg); padding: 8px 13px 13px; }
    .det-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 8px;
    }
    .det-item {
      background: var(--surface); border: 1px solid var(--border);
      border-radius: var(--r-sm); padding: 7px 10px;
    }
    .det-lbl { font-size: 10px; color: var(--muted); text-transform: uppercase; letter-spacing: .4px; margin-bottom: 3px; }
    .det-val { font-size: 13px; font-weight: 600; }

    .show-more-bar { padding: 10px; border-top: 1px solid var(--border); text-align: center; }
    .btn-more {
      padding: 5px 14px;
      border: 1px solid var(--border); background: var(--surface2);
      color: var(--dim); border-radius: var(--r-sm);
      cursor: pointer; font-size: 12px; transition: all .15s;
    }
    .btn-more:hover { border-color: var(--accent); color: var(--accent); }

    /* â”€â”€ Symbol cell â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .sym-cell { display: flex; align-items: center; gap: 8px; }
    .sym-icon {
      width: 28px; height: 28px; border-radius: 50%;
      background: var(--accent-bg); border: 1px solid rgba(59,130,246,.35);
      display: flex; align-items: center; justify-content: center;
      font-size: 9px; font-weight: 700; color: var(--accent);
      flex-shrink: 0; letter-spacing: -.5px;
    }
    .sym-name { font-weight: 600; font-size: 13px; line-height: 1.2; }
    .sym-pair { font-size: 10px; color: var(--muted); }

    /* â”€â”€ Score badge â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .score-badge {
      display: inline-flex; align-items: center; justify-content: center;
      min-width: 50px; padding: 3px 8px;
      border-radius: var(--r-sm); font-weight: 700; font-size: 13px;
    }

    /* â”€â”€ Change â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .pos { color: var(--green); font-weight: 600; }
    .neg { color: var(--red); font-weight: 600; }

    /* â”€â”€ Pressure pill â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .pill {
      display: inline-flex; align-items: center; gap: 3px;
      padding: 2px 9px; border-radius: 999px;
      font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: .4px;
    }
    .pill.buy  { background: var(--green-bg);  color: var(--green);  border: 1px solid rgba(34,197,94,.35); }
    .pill.sell { background: var(--red-bg);    color: var(--red);    border: 1px solid rgba(239,68,68,.35); }
    .pill.neu  { background: rgba(107,114,128,.12); color: var(--muted); border: 1px solid rgba(107,114,128,.3); }

    /* â”€â”€ Row action buttons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .acts { display: flex; align-items: center; gap: 4px; }
    .btn-sm {
      display: inline-flex; align-items: center; gap: 3px;
      padding: 3px 9px;
      border: 1px solid var(--border); background: var(--surface2);
      color: var(--dim); border-radius: var(--r-sm);
      cursor: pointer; font-size: 12px; white-space: nowrap; transition: all .15s;
    }
    .btn-sm:hover { border-color: var(--accent); color: var(--accent); }
    .btn-wl {
      display: inline-flex; align-items: center;
      padding: 3px 8px;
      border: 1px solid var(--border); background: transparent;
      color: var(--muted); border-radius: var(--r-sm);
      cursor: pointer; font-size: 15px; transition: all .15s;
    }
    .btn-wl:hover { color: var(--yellow); border-color: var(--yellow); }
    .btn-wl.pinned { color: var(--yellow); border-color: var(--yellow); background: var(--yellow-bg); }

    /* â”€â”€ Empty state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .empty {
      display: flex; flex-direction: column; align-items: center; gap: 6px;
      padding: 48px 20px; color: var(--muted); text-align: center;
    }
    .empty-ico { font-size: 30px; margin-bottom: 4px; }
    .empty-title { font-size: 14px; font-weight: 600; color: var(--dim); }

    /* â”€â”€ Mobile cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .cards { display: flex; flex-direction: column; gap: 8px; }
    .card {
      background: var(--surface); border: 1px solid var(--border);
      border-radius: var(--r); padding: 13px;
      transition: border-color .15s;
    }
    .card.new-row { animation: row-flash 2s ease-out; }
    .card-head { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
    .card-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 9px; }
    .cstat-lbl { font-size: 10px; color: var(--muted); margin-bottom: 2px; }
    .cstat-val { font-size: 13px; font-weight: 600; }
    .card-footer { margin-top: 10px; }
    .btn-full {
      width: 100%; padding: 7px;
      border: 1px solid var(--border); background: var(--surface2);
      color: var(--dim); border-radius: var(--r-sm);
      cursor: pointer; font-size: 13px; transition: all .15s;
    }
    .btn-full:hover { border-color: var(--accent); color: var(--accent); }

    /* â”€â”€ Watchlist empty â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .wl-empty { padding: 56px 20px; text-align: center; color: var(--muted); }
    .wl-empty-ico { font-size: 36px; margin-bottom: 10px; }
    .wl-empty-title { font-size: 15px; font-weight: 600; color: var(--dim); margin-bottom: 6px; }

    /* â”€â”€ Chart modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .chart-modal {
      position: fixed; inset: 0; z-index: 9999;
      display: none; align-items: center; justify-content: center;
      padding: 20px; background: rgba(0,0,0,.82);
      backdrop-filter: blur(5px);
    }
    .chart-modal.open { display: flex; }
    .chart-inner {
      width: min(1100px, 95vw); height: min(720px, 88vh);
      background: var(--bg2); border: 1px solid var(--border);
      border-radius: var(--r); overflow: hidden;
      display: flex; flex-direction: column;
      box-shadow: 0 24px 64px rgba(0,0,0,.55);
    }
    .chart-head {
      display: flex; justify-content: space-between; align-items: center;
      padding: 10px 14px; border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }
    .chart-head-title { font-size: 14px; font-weight: 700; }
    .chart-head-sub { font-size: 11px; color: var(--muted); margin-top: 1px; }
    .close-btn {
      width: 28px; height: 28px;
      border: 1px solid var(--border); background: var(--surface);
      color: var(--muted); border-radius: var(--r-sm);
      cursor: pointer; display: flex; align-items: center; justify-content: center;
      font-size: 16px; line-height: 1; transition: all .15s;
    }
    .close-btn:hover { color: var(--text); border-color: var(--border2); }
    #chartFrame { flex: 1; border: none; background: #131722; }

    /* â”€â”€ Toasts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .toasts {
      position: fixed; bottom: 18px; right: 18px;
      display: flex; flex-direction: column; gap: 7px;
      z-index: 10000; pointer-events: none;
    }
    .toast {
      background: var(--surface3); border: 1px solid var(--border2);
      border-left: 3px solid var(--accent);
      border-radius: var(--r-sm); padding: 9px 13px;
      font-size: 13px; max-width: 270px;
      box-shadow: 0 8px 24px rgba(0,0,0,.4);
      animation: toast-in .25s ease-out;
      pointer-events: all;
    }
    .toast.out { animation: toast-out .25s ease-in forwards; }
    @keyframes toast-in  { from { transform: translateX(110%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    @keyframes toast-out { from { transform: translateX(0); opacity: 1; } to { transform: translateX(110%); opacity: 0; } }

    /* â”€â”€ Responsive â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    @media (max-width: 767px) {
      .brand-name { display: none; }
      .header { padding: 0 12px; }
      .stats-bar { padding: 8px 12px; }
      .stat-val { font-size: 17px; }
      .main { padding: 10px 12px; }
      .ctrl-spacer { display: none; }
      input[type="search"] { width: 120px; }
      input[type="range"] { width: 75px; }
      .tcard { display: none; }
      .cards { display: flex; }
      .chart-modal { padding: 0; }
      .chart-inner { width: 100vw; height: 100svh; border-radius: 0; border: none; }
    }
    @media (min-width: 768px) {
      .cards { display: none; }
    }
  </style>
</head>
<body>

<!-- Header -->
<header class="header">
  <div class="brand">
    <div class="brand-icon">âš¡</div>
    <span class="brand-name">Spot <span>Scanner</span></span>
  </div>
  <div class="header-status">
    <div class="status-dot" id="statusDot"></div>
    <span id="statusText">Connectingâ€¦</span>
  </div>
  <div class="hspacer"></div>
  <div class="header-actions">
    <div class="refresh-wrap hidden" id="refreshWrap">
      <div class="spinner"></div>
      <span>Updating</span>
    </div>
    <button class="icon-btn" id="soundBtn" title="Toggle sound alerts">ğŸ”•</button>
  </div>
</header>

<!-- Stats bar -->
<div class="stats-bar">
  <div class="stat">
    <div class="stat-lbl">Pairs Scanned</div>
    <div class="stat-val a" id="sPairs">â€”</div>
  </div>
  <div class="stat-sep"></div>
  <div class="stat">
    <div class="stat-lbl">Confirmed Alerts</div>
    <div class="stat-val g" id="sAlerts">â€”</div>
  </div>
  <div class="stat-sep"></div>
  <div class="stat">
    <div class="stat-lbl">Early Signals</div>
    <div class="stat-val y" id="sEarly">â€”</div>
  </div>
  <div class="stat-sep"></div>
  <div class="stat">
    <div class="stat-lbl">Last Update</div>
    <div class="stat-val" id="sTime" style="font-size:13px;font-weight:500;">â€”</div>
  </div>
</div>

<!-- Main -->
<main class="main">

  <!-- Controls -->
  <div class="ctrl-bar">
    <div class="tabs" id="tabs">
      <button class="tab-btn active" data-tab="confirmed" type="button">
        Confirmed <span class="badge" id="b-confirmed">0</span>
      </button>
      <button class="tab-btn" data-tab="early" type="button">
        Early <span class="badge" id="b-early">0</span>
      </button>
      <button class="tab-btn" data-tab="watchlist" type="button">
        Watchlist <span class="badge" id="b-watchlist">0</span>
      </button>
    </div>
    <div class="ctrl-spacer"></div>
    <div class="ctrl-group">
      <span class="ctrl-lbl">Min</span>
      <input id="minScore" type="range" min="0" max="100" value="40" />
      <strong class="ctrl-val" id="minScoreLbl">40</strong>
    </div>
    <input id="symSearch" type="search" placeholder="Search symbolâ€¦" />
  </div>

  <!-- Confirmed panel -->
  <section id="panel-confirmed" class="panel active">
    <div class="tcard">
      <div class="tcard-scroll">
        <table>
          <thead>
            <tr>
              <th data-sort="symbol" data-table="confirmed">Symbol <span class="sort-ic">â†•</span></th>
              <th data-sort="score" data-table="confirmed" class="sorted">Score <span class="sort-ic">â†“</span></th>
              <th data-sort="price_change_5m" data-table="confirmed">5m Change <span class="sort-ic">â†•</span></th>
              <th data-sort="volume_ratio" data-table="confirmed">Vol Ratio <span class="sort-ic">â†•</span></th>
              <th data-sort="timestamp" data-table="confirmed">Time <span class="sort-ic">â†•</span></th>
              <th></th>
            </tr>
          </thead>
          <tbody id="cDesk"></tbody>
        </table>
      </div>
      <div class="show-more-bar" id="showMoreBar" style="display:none;">
        <button class="btn-more" id="showMoreBtn" type="button">Show more</button>
      </div>
    </div>
    <div id="cMob" class="cards"></div>
  </section>

  <!-- Early panel -->
  <section id="panel-early" class="panel">
    <div class="tcard">
      <div class="tcard-scroll">
        <table>
          <thead>
            <tr>
              <th data-sort="symbol" data-table="early">Symbol <span class="sort-ic">â†•</span></th>
              <th data-sort="momentum_score" data-table="early" class="sorted">Momentum <span class="sort-ic">â†“</span></th>
              <th>Pressure</th>
              <th data-sort="tps_now" data-table="early">TPS <span class="sort-ic">â†•</span></th>
              <th data-sort="buy_ratio" data-table="early">Buy % <span class="sort-ic">â†•</span></th>
              <th data-sort="spread_bps" data-table="early">Spread <span class="sort-ic">â†•</span></th>
              <th></th>
            </tr>
          </thead>
          <tbody id="eDesk"></tbody>
        </table>
      </div>
    </div>
    <div id="eMob" class="cards"></div>
  </section>

  <!-- Watchlist panel -->
  <section id="panel-watchlist" class="panel">
    <div class="tcard" id="wlCard">
      <div class="tcard-scroll">
        <table>
          <thead>
            <tr>
              <th>Symbol</th>
              <th>Last Score</th>
              <th>Last Alert</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="wlDesk"></tbody>
        </table>
      </div>
    </div>
    <div id="wlMob" class="cards"></div>
    <div id="wlEmpty" class="wl-empty" style="display:none;">
      <div class="wl-empty-ico">â­</div>
      <div class="wl-empty-title">No pinned symbols</div>
      <div style="font-size:13px;">Click â˜… on any alert to pin it here</div>
    </div>
  </section>

</main>

<!-- Chart modal -->
<div id="chartModal" class="chart-modal" role="dialog" aria-modal="true">
  <div class="chart-inner">
    <div class="chart-head">
      <div>
        <div class="chart-head-title" id="chartTitle">Chart</div>
        <div class="chart-head-sub" id="chartSub">5-minute candles Â· Binance Spot</div>
      </div>
      <button class="close-btn" id="closeChartBtn" type="button">âœ•</button>
    </div>
    <iframe id="chartFrame" src="about:blank" title="TradingView Chart"></iframe>
  </div>
</div>

<!-- Toasts -->
<div class="toasts" id="toasts"></div>

<script>
/* â”€â”€ Init state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const S = {
  data: __INITIAL_DATA__,
  tab: 'confirmed',
  minScore: 40,
  search: '',
  showMore: false,
  sound: false,
  paused: false,
  prevAlertKeys: new Set(),
  sortC: { key: 'score',          dir: -1 },
  sortE: { key: 'momentum_score', dir: -1 },
  expC: new Set(),
  expE: new Set(),
  wl:   new Set(JSON.parse(localStorage.getItem('wl') || '[]')),
};

/* â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function n(v, d = 0) {
  const x = Number(v);
  if (!Number.isFinite(x)) return '0';
  return d ? x.toLocaleString(undefined, { minimumFractionDigits: d, maximumFractionDigits: d }) : Math.round(x).toLocaleString();
}

function pct(v, d = 2) {
  const x = Number(v);
  if (!Number.isFinite(x)) return '0.00%';
  return (x >= 0 ? '+' : '') + x.toFixed(d) + '%';
}

function timeStr(iso) {
  if (!iso) return 'â€”';
  return new Date(iso).toLocaleTimeString(undefined, { hour: '2-digit', minute: '2-digit', second: '2-digit' });
}

function relTime(iso) {
  if (!iso) return 'â€”';
  const s = Math.floor((Date.now() - new Date(iso).getTime()) / 1000);
  if (s < 5)    return 'just now';
  if (s < 60)   return s + 's ago';
  if (s < 3600) return Math.floor(s / 60) + 'm ago';
  return Math.floor(s / 3600) + 'h ago';
}

function scoreStyle(score) {
  const s = Math.min(100, Math.max(0, Number(score)));
  let color;
  if (s >= 75) color = '#22c55e';
  else if (s >= 55) color = '#eab308';
  else if (s >= 35) color = '#3b82f6';
  else color = '#6b7280';
  return `background:${color}22;color:${color};border:1px solid ${color}55`;
}

function pressure(buyRatio, cvdRate) {
  const r = Number(buyRatio), c = Number(cvdRate);
  if (r >= 0.6 && c > 0) return { cls: 'buy',  label: 'â–² BUY' };
  if (r <= 0.4 && c < 0) return { cls: 'sell', label: 'â–¼ SELL' };
  return { cls: 'neu', label: 'â— NEUTRAL' };
}

function initials(sym) {
  return sym.replace('USDT', '').slice(0, 3);
}

function tvUrl(symbol, interval = '5') {
  return 'https://s.tradingview.com/widgetembed/?' + new URLSearchParams({
    symbol: 'BINANCE:' + symbol.toUpperCase(),
    interval, theme: 'dark', style: '1',
    timezone: 'Etc/UTC', withdateranges: '1',
    hide_side_toolbar: '0', allow_symbol_change: '0',
  }).toString();
}

function saveWl() {
  localStorage.setItem('wl', JSON.stringify([...S.wl]));
}

/* â”€â”€ Preferences persistence â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function savePrefs() {
  localStorage.setItem('prefs', JSON.stringify({
    minScore: S.minScore,
    search:   S.search,
    tab:      S.tab,
    sortC:    S.sortC,
    sortE:    S.sortE,
    sound:    S.sound,
  }));
}

function loadPrefs() {
  try {
    const p = JSON.parse(localStorage.getItem('prefs') || 'null');
    if (!p) return;
    if (typeof p.minScore === 'number')  S.minScore = p.minScore;
    if (typeof p.search   === 'string')  S.search   = p.search;
    if (typeof p.tab      === 'string')  S.tab      = p.tab;
    if (p.sortC?.key && typeof p.sortC.dir === 'number') S.sortC = p.sortC;
    if (p.sortE?.key && typeof p.sortE.dir === 'number') S.sortE = p.sortE;
    if (typeof p.sound    === 'boolean') S.sound    = p.sound;
  } catch { /* ignore malformed prefs */ }
}

function applyPrefsToDOM() {
  const ms = /** @type {HTMLInputElement} */ (document.getElementById('minScore'));
  ms.value = String(S.minScore);
  document.getElementById('minScoreLbl').textContent = String(S.minScore);
  /** @type {HTMLInputElement} */ (document.getElementById('symSearch')).value = S.search;
  const sb = document.getElementById('soundBtn');
  sb.textContent = S.sound ? 'ğŸ””' : 'ğŸ”•';
  sb.classList.toggle('on', S.sound);
}

function syncSortHeaders() {
  document.querySelectorAll('th[data-sort]').forEach(th => {
    const tbl = th.getAttribute('data-table');
    const key = th.getAttribute('data-sort');
    const st  = tbl === 'confirmed' ? S.sortC : S.sortE;
    const ic  = th.querySelector('.sort-ic');
    if (st.key === key) {
      th.classList.add('sorted');
      if (ic) ic.textContent = st.dir === -1 ? 'â†“' : 'â†‘';
    } else {
      th.classList.remove('sorted');
      if (ic) ic.textContent = 'â†•';
    }
  });
}

/* â”€â”€ Sound â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function beep(freq = 880, dur = 0.18) {
  if (!S.sound) return;
  try {
    const ctx = new AudioContext();
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.connect(gain); gain.connect(ctx.destination);
    osc.frequency.value = freq; osc.type = 'sine';
    gain.gain.setValueAtTime(0.28, ctx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + dur);
    osc.start(); osc.stop(ctx.currentTime + dur);
  } catch { /* AudioContext blocked */ }
}

/* â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function toast(msg) {
  const el = document.createElement('div');
  el.className = 'toast';
  el.textContent = msg;
  document.getElementById('toasts').appendChild(el);
  setTimeout(() => {
    el.classList.add('out');
    setTimeout(() => el.remove(), 260);
  }, 4000);
}

/* â”€â”€ Chart â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
let _preFocusEl = null;

function openChart(sym, interval = '5') {
  const s = String(sym || '').toUpperCase();
  if (!s) return;
  _preFocusEl = document.activeElement;
  document.getElementById('chartTitle').textContent = s.replace('USDT', '') + ' / USDT';
  document.getElementById('chartSub').textContent = interval === '1'
    ? '1-minute candles Â· Binance Spot'
    : '5-minute candles Â· Binance Spot';
  document.getElementById('chartFrame').src = tvUrl(s, interval);
  document.getElementById('chartModal').classList.add('open');
  document.body.style.overflow = 'hidden';
  S.paused = true;
  requestAnimationFrame(() => document.getElementById('closeChartBtn').focus());
}

function closeChart() {
  document.getElementById('chartModal').classList.remove('open');
  document.getElementById('chartFrame').src = 'about:blank';
  document.body.style.overflow = '';
  S.paused = false;
  if (_preFocusEl instanceof HTMLElement) { _preFocusEl.focus(); _preFocusEl = null; }
  void load();
}

/* â”€â”€ Filters & sort â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function filtered() {
  const q = S.search.toUpperCase();
  const ms = S.minScore;

  function filt(arr, scoreKey) {
    return arr
      .filter(x => Number(x?.[scoreKey] ?? 0) >= ms)
      .filter(x => String(x?.symbol || '').toUpperCase().includes(q));
  }

  function sorted(arr, st) {
    return arr.slice().sort((a, b) => {
      const va = a?.[st.key] ?? 0, vb = b?.[st.key] ?? 0;
      const na = typeof va === 'string' ? va : Number(va);
      const nb = typeof vb === 'string' ? vb : Number(vb);
      if (na < nb) return -st.dir;
      if (na > nb) return st.dir;
      return 0;
    });
  }

  const alerts = sorted(filt(S.data?.alerts ?? [], 'score'), S.sortC);
  const early  = sorted(filt(S.data?.early_candidates ?? [], 'momentum_score'), S.sortE);
  return { alerts, early };
}

/* â”€â”€ Build elements â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function symCell(sym) {
  return `<div class="sym-cell">
    <div class="sym-icon">${initials(sym)}</div>
    <div>
      <div class="sym-name">${sym.replace('USDT', '')}</div>
      <div class="sym-pair">/ USDT</div>
    </div>
  </div>`;
}

function scoreBadge(score) {
  const s = Number(score);
  return `<span class="score-badge" style="${scoreStyle(s)}">${Number.isFinite(s) ? s.toFixed(1) : '0.0'}</span>`;
}

function wlBtn(sym) {
  const p = S.wl.has(sym);
  return `<button class="btn-wl js-wl ${p ? 'pinned' : ''}" data-sym="${sym}" title="${p ? 'Unpin' : 'Pin'}">${p ? 'â˜…' : 'â˜†'}</button>`;
}

/* â”€â”€ Render confirmed â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function renderConfirmed(alerts) {
  const desk = document.getElementById('cDesk');
  const mob  = document.getElementById('cMob');
  const moreBar = document.getElementById('showMoreBar');
  const moreBtn = document.getElementById('showMoreBtn');
  desk.innerHTML = ''; mob.innerHTML = '';

  moreBar.style.display = alerts.length > 10 ? '' : 'none';
  if (alerts.length > 10) {
    moreBtn.textContent = S.showMore ? 'Show less' : `Show ${alerts.length - 10} more`;
  }

  if (!alerts.length) {
    desk.innerHTML = `<tr><td colspan="6"><div class="empty"><div class="empty-ico">ğŸ“­</div><div class="empty-title">No confirmed alerts</div><div style="font-size:12px;margin-top:2px;">Waiting for volume spikesâ€¦</div></div></td></tr>`;
    mob.innerHTML  = `<div class="empty"><div class="empty-ico">ğŸ“­</div><div class="empty-title">No confirmed alerts</div></div>`;
    return;
  }

  const list = S.showMore ? alerts : alerts.slice(0, 10);
  list.forEach(a => {
    const sym    = String(a?.symbol || '');
    const score  = Number(a?.score);
    const chg    = Number(a?.price_change_5m);
    const ratio  = Number(a?.volume_ratio);
    const vol    = Number(a?.volume_5m);
    const avgVol = Number(a?.avg_volume_1h);
    const ts     = a?.timestamp;
    const key    = sym + '_c';
    const exp    = S.expC.has(key);
    const isNew  = !S.prevAlertKeys.has(sym);

    // Desktop row
    const tr = document.createElement('tr');
    if (isNew) tr.classList.add('new-row');
    tr.innerHTML = `
      <td>${symCell(sym)}</td>
      <td>${scoreBadge(score)}</td>
      <td><span class="${chg >= 0 ? 'pos' : 'neg'}">${pct(chg)}</span></td>
      <td><strong>${Number.isFinite(ratio) ? ratio.toFixed(2) : '0.00'}Ã—</strong></td>
      <td style="color:var(--muted);font-size:12px;">${timeStr(ts)}</td>
      <td><div class="acts">
        ${wlBtn(sym)}
        <button class="btn-sm js-chart" data-sym="${sym}">Chart</button>
        <button class="btn-sm js-exp-c" data-key="${key}" style="min-width:56px;">${exp ? 'Hide' : 'Details'}</button>
      </div></td>`;
    desk.appendChild(tr);

    if (exp) {
      const dr = document.createElement('tr');
      dr.className = 'det-row';
      dr.innerHTML = `<td colspan="6"><div class="det-grid">
        <div class="det-item"><div class="det-lbl">5m Volume</div><div class="det-val">$${n(vol)}</div></div>
        <div class="det-item"><div class="det-lbl">Avg Vol (1h)</div><div class="det-val">$${n(avgVol)}</div></div>
        <div class="det-item"><div class="det-lbl">Vol Ratio</div><div class="det-val">${Number.isFinite(ratio) ? ratio.toFixed(2) : '0.00'}Ã—</div></div>
        <div class="det-item"><div class="det-lbl">Alert Time</div><div class="det-val">${timeStr(ts)}</div></div>
      </div></td>`;
      desk.appendChild(dr);
    }

    // Mobile card
    const card = document.createElement('div');
    card.className = 'card' + (isNew ? ' new-row' : '');
    card.innerHTML = `
      <div class="card-head">
        <div>${symCell(sym)}</div>
        <div style="display:flex;gap:6px;align-items:center;">${scoreBadge(score)}${wlBtn(sym)}</div>
      </div>
      <div class="card-grid">
        <div><div class="cstat-lbl">5m Change</div><div class="cstat-val ${chg >= 0 ? 'pos' : 'neg'}">${pct(chg)}</div></div>
        <div><div class="cstat-lbl">Vol Ratio</div><div class="cstat-val">${Number.isFinite(ratio) ? ratio.toFixed(2) : '0.00'}Ã—</div></div>
        <div><div class="cstat-lbl">5m Volume</div><div class="cstat-val">$${n(vol)}</div></div>
        <div><div class="cstat-lbl">Time</div><div class="cstat-val" style="font-size:12px;">${timeStr(ts)}</div></div>
      </div>
      <div class="card-footer"><button class="btn-full js-chart" data-sym="${sym}">View Chart</button></div>`;
    mob.appendChild(card);
  });
}

/* â”€â”€ Render early â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function renderEarly(candidates) {
  const desk = document.getElementById('eDesk');
  const mob  = document.getElementById('eMob');
  desk.innerHTML = ''; mob.innerHTML = '';

  if (!candidates.length) {
    const noRawData = (S.data?.candidates_count ?? 0) === 0;
    const ico   = noRawData ? 'â³' : 'ğŸ”';
    const title = noRawData ? 'Warming upâ€¦' : 'No signals above threshold';
    const sub   = noRawData
      ? 'Baseline window fills in ~60 s on first start'
      : 'Try lowering the Min Score filter';
    desk.innerHTML = `<tr><td colspan="7"><div class="empty"><div class="empty-ico">${ico}</div><div class="empty-title">${title}</div><div style="font-size:12px;margin-top:2px;">${sub}</div></div></td></tr>`;
    mob.innerHTML  = `<div class="empty"><div class="empty-ico">${ico}</div><div class="empty-title">${title}</div><div style="font-size:12px;margin-top:4px;">${sub}</div></div>`;
    return;
  }

  candidates.slice(0, 60).forEach(c => {
    const sym      = String(c?.symbol || '');
    const mom      = Number(c?.momentum_score);
    const buyR     = Number(c?.buy_ratio);
    const cvdR     = Number(c?.cvd_rate);
    const tps      = Number(c?.tps_now);
    const spread   = Number(c?.spread_bps);
    const notional = Number(c?.recent_notional);
    const spreadCo = Number(c?.spread_compression);
    const p        = pressure(buyR, cvdR);
    const key      = sym + '_e';
    const exp      = S.expE.has(key);

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${symCell(sym)}</td>
      <td>${scoreBadge(mom)}</td>
      <td><span class="pill ${p.cls}">${p.label}</span></td>
      <td>${Number.isFinite(tps) ? tps.toFixed(2) : '0'}</td>
      <td>${pct(buyR * 100, 1)}</td>
      <td style="color:var(--dim);">${Number.isFinite(spread) ? spread.toFixed(2) : '0'} bps</td>
      <td><div class="acts">
        ${wlBtn(sym)}
        <button class="btn-sm js-chart" data-sym="${sym}" data-interval="1">Chart</button>
        <button class="btn-sm js-exp-e" data-key="${key}" style="min-width:56px;">${exp ? 'Hide' : 'Details'}</button>
      </div></td>`;
    desk.appendChild(tr);

    if (exp) {
      const dr = document.createElement('tr');
      dr.className = 'det-row';
      dr.innerHTML = `<td colspan="7"><div class="det-grid">
        <div class="det-item"><div class="det-lbl">Buy Ratio</div><div class="det-val">${pct(buyR * 100, 1)}</div></div>
        <div class="det-item"><div class="det-lbl">CVD / s</div><div class="det-val">$${n(cvdR)}</div></div>
        <div class="det-item"><div class="det-lbl">TPS (now)</div><div class="det-val">${Number.isFinite(tps) ? tps.toFixed(2) : '0'}</div></div>
        <div class="det-item"><div class="det-lbl">Spread</div><div class="det-val">${Number.isFinite(spread) ? spread.toFixed(2) : '0'} bps</div></div>
        <div class="det-item"><div class="det-lbl">10s Notional</div><div class="det-val">$${n(notional)}</div></div>
        <div class="det-item"><div class="det-lbl">Spread Compression</div><div class="det-val">${pct(spreadCo * 100, 1)}</div></div>
      </div></td>`;
      desk.appendChild(dr);
    }

    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `
      <div class="card-head">
        <div>${symCell(sym)}</div>
        <div style="display:flex;gap:6px;align-items:center;">${scoreBadge(mom)}${wlBtn(sym)}</div>
      </div>
      <div style="margin:8px 0;"><span class="pill ${p.cls}">${p.label}</span></div>
      <div class="card-grid">
        <div><div class="cstat-lbl">Buy Ratio</div><div class="cstat-val">${pct(buyR * 100, 1)}</div></div>
        <div><div class="cstat-lbl">TPS</div><div class="cstat-val">${Number.isFinite(tps) ? tps.toFixed(2) : '0'}</div></div>
        <div><div class="cstat-lbl">CVD / s</div><div class="cstat-val">$${n(cvdR)}</div></div>
        <div><div class="cstat-lbl">Spread</div><div class="cstat-val">${Number.isFinite(spread) ? spread.toFixed(2) : '0'} bps</div></div>
      </div>
      <div class="card-footer"><button class="btn-full js-chart" data-sym="${sym}" data-interval="1">View Chart</button></div>`;
    mob.appendChild(card);
  });
}

/* â”€â”€ Render watchlist â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function renderWatchlist() {
  const desk  = document.getElementById('wlDesk');
  const mob   = document.getElementById('wlMob');
  const card  = document.getElementById('wlCard');
  const empty = document.getElementById('wlEmpty');
  desk.innerHTML = ''; mob.innerHTML = '';

  if (!S.wl.size) {
    card.style.display = 'none'; empty.style.display = '';
    return;
  }
  card.style.display = ''; empty.style.display = 'none';

  const bySymbol = new Map((S.data?.alerts ?? []).map(a => [a.symbol, a]));

  [...S.wl].forEach(sym => {
    const a     = bySymbol.get(sym);
    const score = a ? Number(a.score) : null;

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${symCell(sym)}</td>
      <td>${score !== null ? scoreBadge(score) : '<span style="color:var(--muted)">â€”</span>'}</td>
      <td style="color:var(--muted);font-size:12px;">${a ? timeStr(a.timestamp) : 'â€”'}</td>
      <td><div class="acts">
        <button class="btn-sm js-chart" data-sym="${sym}">Chart</button>
        <button class="btn-wl pinned js-wl" data-sym="${sym}" title="Unpin">â˜…</button>
      </div></td>`;
    desk.appendChild(tr);

    const c = document.createElement('div');
    c.className = 'card';
    c.innerHTML = `
      <div class="card-head">
        <div>${symCell(sym)}</div>
        <div style="display:flex;gap:6px;align-items:center;">
          ${score !== null ? scoreBadge(score) : ''}
          <button class="btn-wl pinned js-wl" data-sym="${sym}" title="Unpin">â˜…</button>
        </div>
      </div>
      <div class="card-footer"><button class="btn-full js-chart" data-sym="${sym}">View Chart</button></div>`;
    mob.appendChild(c);
  });
}

/* â”€â”€ Render meta â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function renderMeta() {
  const d = S.data || {};
  document.getElementById('sPairs').textContent  = n(d.scanned_pairs)    || 'â€”';
  document.getElementById('sAlerts').textContent = n(d.alerts_count)     || '0';
  document.getElementById('sEarly').textContent  = n(d.candidates_count) || '0';
  document.getElementById('sTime').textContent   = relTime(d.last_scan_at);
}

function renderBadges(alerts, early) {
  document.getElementById('b-confirmed').textContent = alerts.length;
  document.getElementById('b-early').textContent     = early.length;
  document.getElementById('b-watchlist').textContent = S.wl.size;
}

function renderTabs() {
  document.querySelectorAll('.tab-btn').forEach(b =>
    b.classList.toggle('active', b.getAttribute('data-tab') === S.tab)
  );
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  const panel = document.getElementById('panel-' + S.tab);
  if (panel) panel.classList.add('active');
}

/* â”€â”€ New alert detection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function checkNew(alerts) {
  const newOnes = alerts.filter(a => !S.prevAlertKeys.has(a.symbol));
  if (newOnes.length) {
    beep();
    newOnes.forEach(a => toast('Alert: ' + a.symbol));
  }
  S.prevAlertKeys = new Set(alerts.map(a => a.symbol));
}

/* â”€â”€ Render all â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function renderAll() {
  const { alerts, early } = filtered();
  renderMeta();
  renderBadges(alerts, early);
  renderTabs();
  syncSortHeaders();
  renderConfirmed(alerts);
  renderEarly(early);
  renderWatchlist();
}

/* â”€â”€ Data load â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function load() {
  if (S.paused) return;
  const rw = document.getElementById('refreshWrap');
  rw.classList.remove('hidden');
  try {
    const res = await fetch('/alerts', { signal: AbortSignal.timeout(6000) });
    if (!res.ok) throw new Error('HTTP ' + res.status);
    S.data = await res.json();
    const { alerts } = filtered();
    checkNew(alerts);
    renderAll();
    document.getElementById('statusDot').classList.remove('err');
    document.getElementById('statusText').textContent = 'Live';
  } catch {
    document.getElementById('statusDot').classList.add('err');
    document.getElementById('statusText').textContent = 'Connection error';
  } finally {
    rw.classList.add('hidden');
  }
}

/* â”€â”€ Events â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
document.getElementById('tabs').addEventListener('click', e => {
  const b = e.target.closest('.tab-btn');
  if (b) { S.tab = b.getAttribute('data-tab') || 'confirmed'; savePrefs(); renderAll(); }
});

document.getElementById('minScore').addEventListener('input', e => {
  S.minScore = Number(e.target.value) || 0;
  document.getElementById('minScoreLbl').textContent = S.minScore;
  savePrefs(); renderAll();
});

document.getElementById('symSearch').addEventListener('input', e => {
  S.search = String(e.target.value || '');
  savePrefs(); renderAll();
});

document.getElementById('showMoreBtn').addEventListener('click', () => {
  S.showMore = !S.showMore; renderAll();
});

document.getElementById('soundBtn').addEventListener('click', () => {
  S.sound = !S.sound;
  const b = document.getElementById('soundBtn');
  b.textContent = S.sound ? 'ğŸ””' : 'ğŸ”•';
  b.classList.toggle('on', S.sound);
  savePrefs();
  if (S.sound) beep(660, 0.1);
});

/* Column sorting */
document.querySelectorAll('th[data-sort]').forEach(th => {
  th.addEventListener('click', () => {
    const key   = th.getAttribute('data-sort');
    const tbl   = th.getAttribute('data-table');
    const st    = tbl === 'confirmed' ? S.sortC : S.sortE;
    st.dir      = st.key === key ? -st.dir : -1;
    st.key      = key;
    savePrefs();
    renderAll();
  });
});

/* Delegated clicks */
document.addEventListener('click', e => {
  const t = e.target;
  if (!(t instanceof Element)) return;

  const chart = t.closest('.js-chart');
  if (chart) { openChart(chart.dataset.sym, chart.dataset.interval || '5'); return; }

  const wl = t.closest('.js-wl');
  if (wl) {
    const s = wl.dataset.sym;
    if (S.wl.has(s)) { S.wl.delete(s); toast(s + ' removed from watchlist'); }
    else             { S.wl.add(s);    toast(s + ' added to watchlist'); }
    saveWl(); renderAll(); return;
  }

  const ec = t.closest('.js-exp-c');
  if (ec) {
    const k = ec.dataset.key;
    S.expC.has(k) ? S.expC.delete(k) : S.expC.add(k);
    renderAll(); return;
  }

  const ee = t.closest('.js-exp-e');
  if (ee) {
    const k = ee.dataset.key;
    S.expE.has(k) ? S.expE.delete(k) : S.expE.add(k);
    renderAll(); return;
  }

  if (t.id === 'closeChartBtn' || t.id === 'chartModal') closeChart();
});

document.addEventListener('keydown', e => {
  if (e.key === 'Escape') { closeChart(); return; }

  if (e.key === 'Tab' && document.getElementById('chartModal').classList.contains('open')) {
    const focusable = [...document.querySelector('.chart-inner').querySelectorAll(
      'button:not([disabled]), [href], input:not([disabled]), [tabindex]:not([tabindex="-1"])'
    )];
    if (!focusable.length) { e.preventDefault(); return; }
    const first = focusable[0], last = focusable[focusable.length - 1];
    if (e.shiftKey) {
      if (document.activeElement === first) { e.preventDefault(); last.focus(); }
    } else {
      if (document.activeElement === last)  { e.preventDefault(); first.focus(); }
    }
  }
});

/* â”€â”€ Boot â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
loadPrefs();
applyPrefsToDOM();
if (S.data) {
  S.prevAlertKeys = new Set((S.data.alerts ?? []).map(a => a.symbol));
  renderAll();
}
void load();
setInterval(load, 7000);
setInterval(() => {
  const el = document.getElementById('sTime');
  if (el && S.data?.last_scan_at) el.textContent = relTime(S.data.last_scan_at);
}, 10000);
</script>
</body>
</html>
